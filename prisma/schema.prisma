generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Task {
  id                  String        @id @default(uuid())
  status              String        @default("pending")
  currentStep         Int           @default(0)
  totalSteps          Int           @default(4)
  failedStep          Int?
  competitorImagePath String?
  productImagePath    String?
  resultImagePath     String?
  competitorAnalysis  String?
  contentAnalysis     String?
  generatedPrompt     String?
  usedModels          String?
  errorMessage        String?
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
  totalCost           Float?
  brandTone           String?
  productCategory     String?
  productName         String?
  sellingPoints       String?
  targetAudience      String?
  competitorCategory  String?
  competitorName      String?
  resultImages        String?
  selectedImageModels String?
  generationMode      String?
  styleTemplateId     String?
  jimenResolution     String?
  usageScenario       String?
  // 批量任务关联
  batchTaskId         String?
  batchTask           BatchTask?    @relation(fields: [batchTaskId], references: [id], onDelete: Cascade)
  batchIndex          Int?
  apiCalls            ApiCall[]
  imageRatings        ImageRating[]
  stepTimings         StepTiming[]
  taskRating          TaskRating?

  @@index([batchTaskId])
}

model BatchTask {
  id                  String    @id @default(uuid())
  status              String    @default("pending") // pending | processing | completed | partial_failed | failed
  totalCount          Int
  completedCount      Int       @default(0)
  failedCount         Int       @default(0)

  // 共享配置
  generationMode      String                         // competitor | template
  competitorImagePath String?
  styleTemplateId     String?
  competitorName      String?
  competitorCategory  String?
  productInfo         String?                        // JSON: ProductInfo (不含 productName)
  selectedImageModels String                         // JSON: string[]
  jimenResolution     String    @default("2k")
  usageScenario       String?                        // 使用场景描述

  // 共享分析（竞品分析只做一次）
  competitorAnalysis  String?                        // JSON

  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  tasks               Task[]

  @@index([status])
  @@index([createdAt])
}

model ApiCall {
  id               String   @id @default(uuid())
  taskId           String
  step             Int
  generationId     String
  model            String
  totalCost        Float
  tokensPrompt     Int?
  tokensCompletion Int?
  latency          Int?
  createdAt        DateTime @default(now())
  task             Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([taskId])
}

model StepTiming {
  id        String   @id @default(uuid())
  taskId    String
  step      Int
  duration  Int
  createdAt DateTime @default(now())
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@unique([taskId, step])
  @@index([taskId])
}

model Material {
  id        String   @id @default(uuid())
  name      String?
  path      String
  type      String   @default("product")
  source    String   @default("upload")
  taskId    String?
  fileSize  Int?
  width     Int?
  height    Int?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([type])
  @@index([createdAt])
}

model TaskRating {
  id              String   @id @default(uuid())
  taskId          String   @unique
  overallRating   Int
  imageQuality    Int?
  styleMatch      Int?
  productFidelity Int?
  creativity      Int?
  comment         String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  task            Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([overallRating])
  @@index([createdAt])
}

model ImageRating {
  id              String   @id @default(uuid())
  taskId          String
  imagePath       String
  modelId         String
  provider        String
  overallRating   Int
  imageQuality    Int?
  styleMatch      Int?
  productFidelity Int?
  creativity      Int?
  comment         String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  task            Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@unique([taskId, imagePath])
  @@index([taskId])
  @@index([modelId])
  @@index([overallRating])
  @@index([createdAt])
}
