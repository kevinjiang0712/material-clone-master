generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Task {
  id                  String    @id @default(uuid())
  status              String    @default("pending")
  currentStep         Int       @default(0)
  totalSteps          Int       @default(4)
  failedStep          Int?      // 失败时的步骤号，用于断点重试
  competitorImagePath String?
  productImagePath    String?
  resultImagePath     String?   // 保留兼容旧数据
  resultImages        String?   // JSON 数组: [{provider, model, path, error?}]
  selectedImageModels String?   // JSON 数组: ["jimen:doubao-seedream-4-0-250828", "openrouter:google/gemini-2.5-flash-image"]
  jimenResolution     String?   // 即梦输出分辨率: "1k" | "2k" | "4k"
  competitorAnalysis  String?   // 合并版式+风格分析
  contentAnalysis     String?
  generatedPrompt     String?
  usedModels          String?   // JSON: 每个步骤使用的模型名称
  errorMessage        String?
  totalCost           Float?    // 总成本（美元）
  // 生成模式
  generationMode      String?   // 'competitor' | 'template'，null 视为 competitor
  styleTemplateId     String?   // 模板模式使用的模板 ID
  // 竞品基础信息
  competitorName      String?   // 竞品名称
  competitorCategory  String?   // 竞品类目
  // 商品基础信息
  productName         String?   // 商品名称
  productCategory     String?   // 商品类目
  sellingPoints       String?   // 核心卖点
  targetAudience      String?   // 目标人群
  brandTone           String?   // 品牌调性 (JSON 数组)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  apiCalls            ApiCall[]
  stepTimings         StepTiming[]
}

model ApiCall {
  id               String   @id @default(uuid())
  taskId           String
  task             Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  step             Int      // 步骤号 1/2/4
  generationId     String   // OpenRouter 返回的 gen-xxx
  model            String   // 使用的模型
  totalCost        Float    // 成本（美元）
  tokensPrompt     Int?     // 输入 token
  tokensCompletion Int?     // 输出 token
  latency          Int?     // 延迟（毫秒）
  createdAt        DateTime @default(now())

  @@index([taskId])
}

model StepTiming {
  id        String   @id @default(uuid())
  taskId    String
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  step      Int      // 步骤号 1/2/3/4
  duration  Int      // 耗时（毫秒）
  createdAt DateTime @default(now())

  @@unique([taskId, step])
  @@index([taskId])
}
